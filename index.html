<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Juego con Canvas</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>

<body class="m-0 p-0" id="content-game">
  <div id="render" class="bg-black w-screen h-screen flex items-center justify-center">
    <div class="grid gap-2">
      <img src="images/banner.png" class="mx-auto" width="600px" />

      <div class="flex items-center gap-2 border-white border-t-1 p-2 justify-center">
        <input type="text" class="bg-white p-1 rounded-md" id="nicknameJoin" placeholder="Nickname">
        <input type="text" class="bg-white p-1 rounded-md" id="room" placeholder="Room">
        <button id="join" class="bg-green-900 p-2 rounded-md cursor-pointer text-white text-3xl" onclick="joinRoom()"
          type="button">Unirse a la partida</button>
      </div>
      <div class="flex items-center gap-2 border-white border-t-1 p-2 justify-center">
        <input type="text" class="bg-white p-1 rounded-md" id="nicknameCreate" placeholder="Nickname">
        <button id="create" class="bg-green-900 p-2 rounded-md cursor-pointer text-white text-3xl"
          onclick="createRoom()" type="button">Crear una partida</button>
      </div>

    </div>
    <div id="modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
      <div class="bg-gray-800 rounded-2xl shadow-xl p-6 w-96 relative">

        <!-- Bot√≥n cerrar 
        <button onclick="closeModal()"
          class="absolute top-3 right-3 text-gray-400 hover:text-white text-xl">&times;</button>-->

        <!-- Contenido del modal -->
        <h2 class="text-2xl font-semibold mb-4 text-white" id="titleModal"></h2>
        <p class="text-gray-300 mb-6" id="contentModal">

        <div class="flex items-center justify-center">

        </div>

        </p>



      </div>
    </div>
  </div>
  <div id="sound" class="fixed bottom-2 right-2 flex items-center gap-2 text-white text-lg bg-black/50 p-3 rounded-lg"
    style="z-index:1000; pointer-events:auto;">
    <span id="soundIcon">üîâ</span>
    <input id="volumeControl" type="range" min="0" max="100" value="50" class="w-32 accent-green-500 cursor-pointer"
      onchange="changeVolumen()">
  </div>
  <script type="module" src="js/game.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
  <script>
    let idpeer;
    var globalPeer;
    var total = 0;
    var connectedPlayers = []; // Array para almacenar nicknames de jugadores conectados
    var conexiones = []; // Array para mantener todas las conexiones activas (como en test2.html)
    let gameAudio = new Audio("sounds/2.mp3");
    gameAudio.loop = true;
    const savedVolume = document.cookie.split('; ').find(row => row.startsWith('datasound='));
    if (savedVolume) {
      const volumeValue = savedVolume.split('=')[1];
      document.getElementById("volumeControl").value = volumeValue;
      gameAudio.volume = volumeValue / 100;
    } else {
      gameAudio.volume = 0.5; // volumen inicial 50% si no existe la cookie
    }


    // Bot√≥n de play

    function changeVolumen() {
      const volumeControl = document.getElementById("volumeControl");
      const soundIcon = document.getElementById("soundIcon");
      const value = volumeControl.value;
      gameAudio.volume = value / 100;

      if (value == 0) {
        soundIcon.textContent = "üîá";
      } else if (value < 50) {
        soundIcon.textContent = "üîâ";
      } else {
        soundIcon.textContent = "üîä";
      }
      document.cookie = `datasound=${value}; path=/;`;
    }
  </script>
  <script>
    function initPeer() {
      window.peer = new Peer({
        host: "0.peerjs.com",
        port: 443,
        path: "/",
        secure: true
      });
    }
    function createPeer() {
      initPeer();
      const peer = window.peer;

      peer.on('open', id => {
         total++;
         console.log('Mi ID de peer es: ' + id);
         idpeer = id;
         setAsHost(true);  // Este cliente es el host
         closeModal();
         createdRoom();
       });
      peer.on('connection', conn => {
        if (!window.isHost) return; // Solo el host maneja conexiones

        conexiones.push(conn); // Agregar conexi√≥n a la lista
        total++;
        console.log("Nuevo cliente conectado. Total conexiones:", conexiones.length);

        // Agregar nickname del nuevo jugador (temporal hasta que env√≠e su nick)
        connectedPlayers.push("Jugador " + total);
        updatePlayerCount();

        conn.on('data', data => {
          console.log('Datos recibidos del cliente:', data);

          // Procesar mensajes del juego
          if (typeof data === 'object' && data.type) {
            if (data.type === 'game_start') {
              // Esto no deber√≠a suceder desde clientes, pero por si acaso
              console.warn('Cliente intent√≥ iniciar juego');
            } else {
              window.handlePeerMessage(data, conn.peer);
            }
          } else {
            // Mensaje inicial con nickname
            const nick = data.replace("nick:", "");
            console.log('Cliente se uni√≥ con nickname:', nick);

            // Actualizar el nickname en la lista
            const playerIndex = connectedPlayers.length - 1;
            connectedPlayers[playerIndex] = nick;
            updatePlayersList();

            console.log('Lista actualizada de jugadores:', connectedPlayers);

            // IMPORTANTE: Reenviar la informaci√≥n del nuevo jugador a TODOS los clientes conectados
            const joinMessage = {
              type: 'player_joined',
              nick: nick,
              players: connectedPlayers
            };

            conexiones.forEach(c => {
              if (c.open) {
                c.send(joinMessage);
              }
            });

            console.log('Informaci√≥n de uni√≥n enviada a todos los clientes');
          }
        });

        // Manejar desconexiones
        conn.on('close', () => {
          console.log('Cliente desconectado');
          conexiones = conexiones.filter(c => c !== conn);
          // Aqu√≠ podr√≠amos actualizar la lista de jugadores si es necesario
        });
      });

      //playNow();
    }
    function joinPeers(nick, room) {
      initPeer();

      const peer = window.peer;

      console.log("Peer local:", peer);
      console.log("Intentando conectar con la sala:", room);

      // --- Escucha errores generales del peer (importante)
      peer.on("error", (err) => {
        console.error("‚ö†Ô∏è Error del peer:", err.type, err);
      });

      // Intentar conectar con el host
      

      peer.on("open", () => {
        setAsHost(false);  // Este cliente NO es el host
        conn = peer.connect(room);
        console.log("‚úÖ Conexi√≥n establecida con la sala:", room);
        conn.send("nick:" + nick);

        // Configurar recepci√≥n de mensajes del juego
        conn.on('data', (data) => {
          console.log('Cliente recibi√≥ datos:', data);

          if (typeof data === 'object' && data.type) {
            if (data.type === 'game_start') {
              // Iniciar juego cuando el host presiona el bot√≥n
              console.log('Host inici√≥ el juego');
              closeModal();
              window.playNow();
            } else if (data.type === 'player_joined') {
              // Un nuevo jugador se uni√≥ - actualizar lista
              console.log('Nuevo jugador se uni√≥:', data.nick);
              updateWaitingPlayersList(data.players);
            } else if (data.type === 'player_list_update') {
              // Actualizaci√≥n general de la lista de jugadores
              updateWaitingPlayersList(data.players);
            } else {
              window.handlePeerMessage(data, conn.peer);
            }
          }
          // No hay mensajes de texto simples para unirse
        });

        // NO iniciar el juego aqu√≠ - esperar a que el host presione "Iniciar Partida"
        // window.playNow(); // REMOVIDO
      });

      
    }

    function createRoom() {
      document.getElementById("modal").classList.remove("hidden");
      dataModal("create");
      createPeer();
    }
    function joinRoom() {
      document.getElementById("modal").classList.remove("hidden");
      const nick = document.getElementById("nicknameJoin").value;
      const room = document.getElementById("room").value;
      dataModal("join", nick); // Pasar el nickname para mostrar en la lista de espera
      joinPeers(nick, room);
    }

    // Funci√≥n para determinar si somos host
    function setAsHost(isHostFlag) {
      window.isHost = isHostFlag;
    }
    function createdRoom() {
      document.getElementById("modal").classList.remove("hidden");
      dataModal("created");
    }
    function dataModal(type, playerNick = null) {
      if (type == "create") {
        document.getElementById("titleModal").innerHTML = "Creando partida";
        document.getElementById("contentModal").innerHTML = "Usted como creador de la partida, debe estar siempre conectado a la partida para que los otros jugadores se puedan conectar a la partida.";
        document.getElementById("contentModal").innerHTML += `
        <div class="flex items-center justify-center">
          <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
        </div>
      `;
      }
      else if (type == "join") {
        document.getElementById("titleModal").innerHTML = "Uniendo a la partida";
        document.getElementById("contentModal").innerHTML = `
          <div class="space-y-4">
            <p>Esperando a que el creador inicie la partida...</p>
            <div class="text-center">
              <p class="text-green-400 font-semibold">Tu nickname: ${playerNick || 'Jugador'}</p>
              <div class="mt-2">
                <p class="text-white text-sm mb-1">Jugadores en la sala:</p>
                <div id="waitingPlayersList" class="text-left bg-gray-800 p-2 rounded max-h-32 overflow-y-auto">
                  <div class="text-gray-400 text-sm">Cargando...</div>
                </div>
              </div>
            </div>
            <div class="flex items-center justify-center">
              <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
            </div>
          </div>
        `;
      }
      else if (type == "created") {
        // Agregar el nickname del creador
        const creatorNick = document.getElementById("nicknameCreate").value || "Creador";
        connectedPlayers = [creatorNick];

        document.getElementById("titleModal").innerHTML = "Partida Creada !!!";
        document.getElementById("contentModal").innerHTML = `
          <div class="space-y-4">
            <div class="flex items-center gap-2">
              <span class="text-white">ID de sala:</span>
              <input type="text" id="roomIdDisplay" value="${idpeer}" readonly
                     class="bg-gray-700 text-white px-2 py-1 rounded flex-1 text-sm">
              <button onclick="copyRoomId(this)" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                Copiar
              </button>
            </div>
            <div class="text-center">
              <p class="text-green-400 font-semibold" id="totalplayers">Jugadores conectados: ${total}</p>
              <div class="mt-2">
                <p class="text-white text-sm mb-1">Jugadores:</p>
                <div id="playersList" class="text-left bg-gray-800 p-2 rounded max-h-32 overflow-y-auto">
                  <div class="text-green-400 text-sm">‚Ä¢ ${creatorNick} (T√∫)</div>
                </div>
              </div>
              <p class="text-gray-400 text-sm mt-2">Esperando a m√°s jugadores...</p>
            </div>
            <div class="flex justify-center">
              <button id="startGameBtn" onclick="startGameForAll()"
                      class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                      disabled>
                Iniciar Partida
              </button>
            </div>
          </div>
        `;
        updateStartButton();
      }
    }

    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
    }

    // Funci√≥n para copiar el ID de la sala al portapapeles
    function copyRoomId(buttonElement) {
      const roomIdInput = document.getElementById("roomIdDisplay");
      roomIdInput.select();
      roomIdInput.setSelectionRange(0, 99999); // Para m√≥viles
      navigator.clipboard.writeText(roomIdInput.value).then(() => {
        // Mostrar feedback visual
        const button = buttonElement;
        const originalText = button.textContent;
        button.textContent = "¬°Copiado!";
        button.classList.add("bg-green-600");
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove("bg-green-600");
        }, 2000);
      }).catch(err => {
        console.error('Error al copiar: ', err);
        // Fallback silencioso para navegadores antiguos
        const textArea = document.createElement("textarea");
        textArea.value = roomIdInput.value;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
      });
    }

    // Actualizar el contador de jugadores y el estado del bot√≥n
    function updatePlayerCount() {
      const playerCountElement = document.getElementById("totalplayers");
      if (playerCountElement) {
        playerCountElement.textContent = `Jugadores conectados: ${total}`;
        updatePlayersList();
        updateStartButton();
      }
    }

    // Actualizar la lista visual de jugadores
    function updatePlayersList() {
      const playersListElement = document.getElementById("playersList");
      if (playersListElement) {
        playersListElement.innerHTML = connectedPlayers.map((nick, index) =>
          `<div class="text-green-400 text-sm">‚Ä¢ ${nick}${index === 0 ? ' (T√∫)' : ''}</div>`
        ).join('');
      }
    }

    // Actualizar el estado del bot√≥n de iniciar partida
    function updateStartButton() {
      const startBtn = document.getElementById("startGameBtn");
      if (startBtn) {
        if (total >= 2) {
          startBtn.disabled = false;
          startBtn.textContent = "Iniciar Partida";
        } else {
          startBtn.disabled = true;
          startBtn.textContent = "Esperando m√°s jugadores...";
        }
      }
    }

    // Actualizar la lista de jugadores esperando (para clientes)
    function updateWaitingPlayersList(players) {
      const waitingListElement = document.getElementById("waitingPlayersList");
      if (waitingListElement && players) {
        waitingListElement.innerHTML = players.map(nick =>
          `<div class="text-green-400 text-sm">‚Ä¢ ${nick}</div>`
        ).join('');
      }
    }

    // Funci√≥n para enviar la lista de jugadores a todos los clientes
    function broadcastPlayerList() {
      if (!window.isHost) return; // Solo el host puede hacer broadcast

      const playerListMessage = {
        type: 'player_list_update',
        players: connectedPlayers
      };

      console.log('HOST: Enviando lista de jugadores a todos los clientes:', connectedPlayers);

      // Enviar a TODAS las conexiones activas usando el array conexiones
      let sentCount = 0;
      conexiones.forEach(conn => {
        if (conn && conn.open) {
          conn.send(playerListMessage);
          sentCount++;
        }
      });

      console.log(`Lista enviada a ${sentCount} conexiones activas`);
    }

    // Iniciar el juego para todos los jugadores conectados
    function startGameForAll() {
      if (!window.isHost) return; // Solo el host puede iniciar

      if (total < 2) {
        alert("Necesitas al menos 2 jugadores para iniciar la partida");
        return;
      }

      console.log("HOST: Iniciando partida para todos los jugadores conectados...");

      // Enviar mensaje de inicio a todos los jugadores conectados
      const startMessage = { type: 'game_start' };

      // Enviar usando el array conexiones (como en test2.html)
      let sentCount = 0;
      conexiones.forEach(conn => {
        if (conn && conn.open) {
          conn.send(startMessage);
          sentCount++;
          console.log(`Mensaje de inicio enviado a cliente ${sentCount}`);
        }
      });

      console.log(`Total mensajes de inicio enviados: ${sentCount}`);

      // Iniciar el juego localmente (para el host)
      closeModal();
      window.playNow();
    }
  </script>


</body>

</html>